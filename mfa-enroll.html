<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Enrolamento MFA</title>
  <link rel="stylesheet" href="static/css/styles.css"/>
</head>
<body>
  <main>
    <h2>Enrolar Autenticador</h2>
    <div id="mfaQr"></div>
    <p>Ou digite o código manualmente:</p>
    <p id="manualCode"></p>
    <form id="mfaForm">
      <input name="code" maxlength="6" placeholder="000000" required/>
      <button type="submit">Validar e ativar</button>
    </form>
    <div id="backupCodes"></div>
    <p><a href="index.html">Voltar</a></p>
  </main>
  <script>
    const api = "https://cloud-project-web-mfa-backend.onrender.com";

    const url = new URL(window.location.href);
    const temp = url.searchParams.get("temp");

    if(!temp) {
      alert("Token de enrolamento ausente");
    }

    async function loadMfaEnroll() {
      const res = await fetch(`${api}/mfa/enroll?temp=${encodeURIComponent(temp)}`);
      if(!res.ok) {
        alert("Token inválido ou expirado");
        return;
      }
      const data = await res.json();
      document.getElementById("mfaQr").innerHTML =
        `<img alt="QRCode" src="${data.qr_png_data_uri}" style="width:180px"/>`;
      document.getElementById("manualCode").innerText = data.secret;

      window.username = data.username;
    }

    loadMfaEnroll();

    document.getElementById("mfaForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const code = fd.get("code").trim();

      const res = await fetch(`${api}/api/mfa/enroll`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({code, username: window.username})
      });
      const data = await res.json();

      if(res.ok) {
        let codes = data.backup_codes.map(c => `<code>${c}</code>`).join("<br>");
        document.getElementById("backupCodes").innerHTML =
          `<h3>Backup codes: Salve!</h3>${codes}`;
        alert("MFA ativado com sucesso! Guarde seus códigos de backup.");
      } else {
        alert(data.detail || "Erro no enrolamento MFA.");
      }
    });
  </script>
</body>
</html>
